<!DOCTYPE html>
<html>
<head>
  <meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
  <title>handler</title>
</head>
<body>
%%[
    
    SET @origin = HTTPRequestHeader("Referer")
    set @url= CloudPagesURL(7786)  
    /*   */
    SET @pattern =Concat("^",Substring(@url,1, Subtract(IndexOf(@url,"?"),1)),".*")
    SET @match = RegExMatch(@origin, @pattern, 0)

]%%
<script>
console.log("%%=v(@origin)=%%")
console.log("%%=v(@pattern)=%%")
console.log("%%=v(@match)=%%")
</script>
<script runat="server">
    Platform.Load("core","1");
    var MATCH = Variable.GetValue("@match");
    if (!MATCH) { MATCH = null }
    HTTPHeader.SetValue("Access-Control-Allow-Methods","POST");
    HTTPHeader.SetValue("Access-Control-Allow-Origin",MATCH);
   Platform.Response.SetResponseHeader("Strict-Transport-Security","max-age=200");
   Platform.Response.SetResponseHeader("X-XSS-Protection","1; mode=block");
   Platform.Response.SetResponseHeader("X-Frame-Options","Deny");
   Platform.Response.SetResponseHeader("X-Content-Type-Options","nosniff");
   Platform.Response.SetResponseHeader("Referrer-Policy","strict-origin-when-cross-origin");
   Platform.Response.SetResponseHeader("Content-Security-Policy","default-src 'self'");
</script>

%%[



IF LENGTH(@match) > 0 THEN  

   SET @subscriberkey= _subscriberkey

IF NOT EMPTY(@subscriberkey) THEN
set @firstName=RequestParameter("email")
set @lastName=RequestParameter("firstname")
set @email=RequestParameter("lastname")


set @hasOptedOut=Iif(RequestParameter("hasoptedout") == "on", "true", "false")
set @newsletter=Iif(RequestParameter("newsletter") == "on", "true", "false")
set @events=Iif(RequestParameter("events") == "on", "true", "false")
set @offers=Iif(RequestParameter("offers") == "on", "true", "false")

 set @rowsAffected=UpsertData("prefcenter",1, "SubscriberKey",@subscriberkey, "HasOptedOut",@hasOptedOut,
  "Newsletter", @newslette, "Events",@events, "Offers", @offers)


 IF RequestParameter("unsubAll") != "on" THEN
/* Set the correct status in All subscribers, run UnsubEvent, provide the reason for unsubscribing */

    SET @Subscriber = CreateObject("Subscriber")
    SetObjectProperty(@Subscriber, "SubscriberKey", @subscriberKey)
    SetObjectProperty(@Subscriber, "EmailAddress", @email)
    SetObjectProperty(@Subscriber, "Status", "Active" )
    SET @Status = InvokeUpdate(@Subscriber, @createErrDesc, @createErrNo, @createOpts)
    
   ELSEIF RequestParameter("unsubAll") == "on" THEN
    
    SET @lue = CreateObject("ExecuteRequest")
    SETObjectProperty(@lue,"Name","LogUnsubEvent")

    SET @lue_prop = CreateObject("APIProperty")
    SETObjectProperty(@lue_prop, "Name", "SubscriberKey")
    SETObjectProperty(@lue_prop, "Value", @subscriberKey)
    AddObjectArrayItem(@lue, "Parameters", @lue_prop)
   
    SET @lue_prop = CreateObject("APIProperty")
    SETObjectProperty(@lue_prop, "Name", "Reason")
    SETObjectProperty(@lue_prop, "Value", "Unsubscribed through custom subscription center")
    AddObjectArrayItem(@lue, "Parameters", @lue_prop)
    
/*Update the unsubscribe from all list*/
    SET @ll_sub = CreateObject("Subscriber")

    SetObjectProperty(@ll_sub,"EmailAddress", @email)
    SetObjectProperty(@ll_sub,"SubscriberKey", @subscriberKey)

    SetObjectProperty(@ll_sub,"Status","Unsubscribed")
    Set @options = CreateObject("UpdateOptions")
    Set @save = CreateObject("SaveOption")
    SetObjectProperty(@save,"SaveAction","UpdateAdd")
    SetObjectProperty(@save,"PropertyName","Status")
    AddObjectArrayItem(@options,"SaveOptions", @save)

/* Here is where we actually update the Subscriber object */
    SET @lue_statusCode = InvokeExecute(@lue, @overallStatus, @requestId)
    SET @update_sub = InvokeUpdate(@ll_sub, @update_sub_status, @update_sub_errorcode, @options)

if @rowsAffected==1 then
    set @resultMessage="Success"

else
    set @resultMessage="Sorry, something went wrong."
endif

ENDIF
endif
]%%
<div>
%%=v(@resultMessage)=%%
</div>
</body>
</html>